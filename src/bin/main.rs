use clap::Parser as CliParser;
use quake_log_parser::{error::Result, parser::Parser, report::LogReport};
use simplelog::{Config, WriteLogger};
use std::{
    fs::{File, OpenOptions},
    io,
    path::PathBuf,
    process::exit,
};

/// Parses a Quake III: Arena log file and prints a grouped data JSON object.
#[derive(Debug, Clone, CliParser)]
struct Arguments {
    /// Path to Quake III: Arena log file.
    #[arg(default_value = "qgames.log")]
    quake_log: PathBuf,
    /// Path to the log generated by this script for troubleshooting.
    #[arg(short = 'l', long = "script-log", default_value = "script.log")]
    script_log: PathBuf,
}

/// Main function proxy that returns errors instead of exiting.
fn try_main() -> Result<()> {
    let args = Arguments::parse();

    let script_log_file = OpenOptions::new()
        .read(false)
        .write(true)
        .append(true)
        .create(true)
        .open(&args.script_log)?;
    WriteLogger::init(
        log::LevelFilter::Warn,
        Config::default(),
        script_log_file,
    )?;

    let quake_file = File::open(&args.quake_log)?;
    let parser = Parser::new(quake_file);
    let report = LogReport::generate(parser)?;
    serde_json::to_writer_pretty(io::stdout(), &report)?;

    Ok(())
}

/// Executable main function.
fn main() {
    if let Err(error) = try_main() {
        eprintln!("{}", error);
        exit(1);
    }
}
